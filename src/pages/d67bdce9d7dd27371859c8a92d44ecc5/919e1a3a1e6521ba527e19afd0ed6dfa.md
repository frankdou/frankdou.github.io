---
title: web-usb设备调用
size: 3056
---
```js
const vendorId = 0x0471, // 打印机的供应商 ID
	productId = 0x0055, // 打印机的产品 ID
	interfaceNumber = 0, // USB 接口号
	endpointNumber = 2 // USB 端点号（用于数据传输）
try {
    async function getAuthorizedDevice() {
	    // 查找已授权的设备
        const devices = await navigator.usb.getDevices()
        const printer = devices.find(
            (d) => d.vendorId === VENDOR_ID && d.productId === PRODUCT_ID
        )

        if (printer) return printer
			
		// 如果未找到，请求用户选择并授权新设备
        return await navigator.usb.requestDevice({
            filters: [{ vendorId: VENDOR_ID, productId: PRODUCT_ID }],
        })
    }
	
    const device = await getAuthorizedDevice()

    if (!device) {
        return
    }

    // 打开设备
    await device.open()
	
    if (device.configuration === null)
		await device.selectConfiguration(1)
		await device.claimInterface(interfaceNumber) // 占用接口
		await device.selectAlternateInterface(interfaceNumber, 0)

	// 将 printData 数组中所有的 Uint8Array 元素连接成一个单一的 Uint8Array，这是 WebUSB transferOut 所需的数据格式。
	const fullBuffer = new Uint8Array(
		...
	)
	
	// 通过 USB 发送数据
	const result = await device.transferOut(
		endpointNumber,
		fullBuffer
	)

	// 清理资源
	await device.releaseInterface(interfaceNumber)
	await device.close()
	
	return { success: true, bytesWritten: result.bytesWritten }
} catch (error) {
    console.error("WebUSB设备打开失败:", error)
}
```

文本数据转换为Uint8Array
- `Uint8Array` 是 JavaScript **[类型化数组 (Typed Arrays)](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Typed_arrays)** 家族的一员
- 它是一个数组，其元素被限制为 **8 位无符号整数**（即每个元素的值范围是 0 到 255）
- 它用于处理**原始二进制数据**，在 WebUSB、文件 I/O、Canvas 图像处理等场景中非常重要
- 它将人类可读的文本和格式指令，转换为打印机可识别的底层字节码

```js
import iconv from "@vscode/iconv-lite-umd"

try {
    if (
        typeof iconv === "undefined" ||
        !iconv.encodingExists("GB18030")
    ) {
        console.error("iconv-lite not loaded!")
        return new TextEncoder().encode(text)
    }
    const encoded = iconv.encode(text, "GB18030")
    return encoded
} catch (error) {
    console.error("GB18030 encoding failed:", error)
    try {
        return iconv.encode(text, "GBK")
    } catch (e) {
        return new TextEncoder().encode(text)
    }
}
```

VENDOR_ID、PRODUCT_ID获取

```
system_profiler SPUSBDataType
```


interfaceNumber、endpointNumber

|                                       | 常用值   |
| ------------------------------------- | ----- |
| **接口号** (`interfaceNumber`)           | 0 或 1 |
| **输出端点号** (`endpointNumber`)          | 1 或 2 |
| **备用设置** (`selectAlternateInterface`) | 0 或 1 |

调用web usb接口，提示access deneied
https://zadig.akeo.ie/
